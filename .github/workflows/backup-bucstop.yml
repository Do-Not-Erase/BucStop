name: Remote Backup (IPv6)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * *"

jobs:
  backup:
    runs-on: ubuntu-latest
    env:
      KEEP_DAYS: "7"
      REMOTE_BACKUP_DIR: "/opt/bucstop/backups"
      SNAP_DIR: "/var/lib/bucstop/snapshots-data"
      LOG_DIR: "/var/lib/bucstop/logs-data"

    steps:
      - name: Validate secrets exist
        run: |
          set -eu
          [ -n "${{ secrets.PI_HOST }}" ] || { echo "Missing secret: PI_HOST"; exit 1; }
          [ -n "${{ secrets.PI_USER }}" ] || { echo "Missing secret: PI_USER"; exit 1; }
          [ -n "${{ secrets.PI_SSH_KEY }}" ] || { echo "Missing secret: PI_SSH_KEY"; exit 1; }
          echo "Secrets present."

      - name: Sanity ping (IPv6)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PI_HOST }}
          username: ${{ secrets.PI_USER }}
          key: ${{ secrets.PI_SSH_KEY }}
          port: 22
          script_stop: true
          command_timeout: 5m
          script: |
            set -Eeuo pipefail
            echo "Connected to $(hostname) as $(whoami)"
            echo "IPv6 reachability OK"
            date

      - name: Run remote backup (tar + prune)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PI_HOST }}
          username: ${{ secrets.PI_USER }}
          key: ${{ secrets.PI_SSH_KEY }}
          port: 22
          script_stop: true
          command_timeout: 60m
          envs: KEEP_DAYS,REMOTE_BACKUP_DIR,SNAP_DIR,LOG_DIR
          script: |
            set -Eeuo pipefail

            mkdir -p "$REMOTE_BACKUP_DIR"
            ts="$(date +'%Y%m%d_%H%M%S')"

            echo "Starting backup..."
            tar -czf "$REMOTE_BACKUP_DIR/snapshots-data_${ts}.tgz" "$SNAP_DIR"
            tar -czf "$REMOTE_BACKUP_DIR/logs-data_${ts}.tgz" "$LOG_DIR"

            echo "Backup files:"
            ls -lh "$REMOTE_BACKUP_DIR" | sed -n '1,200p'

            echo "Pruning old backups..."
            find "$REMOTE_BACKUP_DIR" -type f -name '*.tgz' -mtime +${KEEP_DAYS} -print -delete

            echo "âœ… Backup complete"
