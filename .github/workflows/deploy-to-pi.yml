name: Deploy to Raspberry Pi  # Workflow: build, smoke-test, rollback on failure, record success

on:
  push:
   branches: [ "F_AutoTestDeploy", "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Clone
      
      # Initial build to ensure new commit is being tested.
      - name: Build images for smoke test
        run: | 
           docker compose up -d

      - name: Run smoke test via wrapper (reachability-only)
        env:
          REACHABILITY_ONLY: "1"
          run: |
           chmod +x Scripts/smoke-test.sh
           ./Scripts/smoke-test.sh

      - name: Deploy with Docker Compose
        if: success()
        run: |
         echo "Smoke Test success! Deploying."
         set -ex 
         docker compose down || true
         docker compose up -d --build

      - name: Handle smoke test failure
        if: failure()
        run: |
          echo "Smoke test failed! skipping deployment"
          docker compose down || true
